<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智链 - AI智能阅读助手</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/glassmorphism.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="dark-theme">
    <!-- 动态背景 -->
    <div id="dynamicBackground" class="dynamic-background">
        <div class="gradient-background" id="gradientBackground"></div>
        <div class="particles-container">
            <!-- 粒子将通过JS动态生成 -->
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <nav class="navbar glass">
        <div class="navbar-left">
            <div class="logo">
                <i class="fas fa-link"></i>
                <span class="logo-text">智链</span>
            </div>
        </div>
        
        <div class="navbar-center">
            <div class="nav-functions">
                <button class="function-btn active" id="intelligentReading" data-function="intelligent-reading" data-target="welcomeScreen">
                    <i class="fas fa-book-reader"></i>
                    <span>智能伴读</span>
                </button>
                <button class="function-btn" id="comprehensiveAnalysis" data-function="comprehensive-analysis" data-target="welcomeScreen">
                    <i class="fas fa-chart-bar"></i>
                    <span>全面总结</span>
                </button>
                <button class="function-btn" id="expertAnalysis" data-function="expert-analysis" data-target="welcomeScreen">
                    <i class="fas fa-user-graduate"></i>
                    <span>大师分析</span>
                </button>
                <button class="function-btn" id="factChecking" data-function="fact-checking" data-target="welcomeScreen">
                    <i class="fas fa-shield-alt"></i>
                    <span>真伪鉴定</span>
                </button>
            </div>
        </div>
        
        <div class="navbar-right">
            <!-- 桌面端导航按钮 -->
            <div class="desktop-nav-items">
                <button class="btn-icon" id="historyToggle" title="聊天历史">
                    <i class="fas fa-history"></i>
                </button>
                <button class="btn-icon" id="themeToggle" title="主题切换">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn-icon" id="backgroundToggle" title="动态背景">
                    <i class="fas fa-eye"></i>
                </button>
                <div class="user-section">
                    <button class="btn-primary" id="loginBtn">登录</button>
                    <div class="user-info" id="userInfo" style="display: none;">
                        <span class="username" id="username"></span>
                        <button class="btn-icon" id="logoutBtn" title="登出">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 移动端汉堡菜单按钮 -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 移动端汉堡菜单 -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay">
        <div class="mobile-menu-content">
            <div class="mobile-menu-header">
                <div class="logo">
                    <i class="fas fa-link"></i>
                    <span class="logo-text">智链</span>
                </div>
                <button class="mobile-menu-close" id="mobileMenuClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 主要功能模式 -->
            <div class="mobile-menu-section">
                <h4 class="mobile-menu-section-title">功能模式</h4>
                <div class="mobile-menu-functions">
                    <button class="mobile-function-btn active" id="mobileIntelligentReading" data-function="intelligent-reading">
                        <div class="mobile-btn-content">
                            <i class="fas fa-book-reader"></i>
                            <div class="mobile-btn-text">
                                <span>智能伴读</span>
                                <small>AI陪伴式阅读体验</small>
                            </div>
                        </div>
                    </button>
                    <button class="mobile-function-btn" id="mobileComprehensiveAnalysis" data-function="comprehensive-analysis">
                        <div class="mobile-btn-content">
                            <i class="fas fa-chart-bar"></i>
                            <div class="mobile-btn-text">
                                <span>全面总结</span>
                                <small>深度分析与总结</small>
                            </div>
                        </div>
                    </button>
                    <button class="mobile-function-btn" id="mobileExpertAnalysis" data-function="expert-analysis">
                        <div class="mobile-btn-content">
                            <i class="fas fa-user-graduate"></i>
                            <div class="mobile-btn-text">
                                <span>大师分析</span>
                                <small>专家级解读分析</small>
                            </div>
                        </div>
                    </button>
                    <button class="mobile-function-btn" id="mobileFactChecking" data-function="fact-checking">
                        <div class="mobile-btn-content">
                            <i class="fas fa-shield-alt"></i>
                            <div class="mobile-btn-text">
                                <span>真伪鉴定</span>
                                <small>事实核查与验证</small>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- 工具与设置 -->
            <div class="mobile-menu-section">
                <h4 class="mobile-menu-section-title">工具与设置</h4>
                <div class="mobile-menu-actions">
                    <button class="mobile-menu-item" id="mobileHistoryToggle">
                        <i class="fas fa-history"></i>
                        <span>聊天历史</span>
                    </button>
                    <button class="mobile-menu-item" id="mobileThemeToggle">
                        <i class="fas fa-moon"></i>
                        <span>主题切换</span>
                    </button>
                    <button class="mobile-menu-item" id="mobileBackgroundToggle">
                        <i class="fas fa-eye"></i>
                        <span>动态背景</span>
                    </button>
                </div>
            </div>
            
            <!-- 用户区域 -->
            <div class="mobile-menu-section">
                <div class="mobile-user-section">
                    <button class="btn-primary" id="mobileLoginBtn">登录</button>
                    <div class="mobile-user-info" id="mobileUserInfo" style="display: none;">
                        <span class="username" id="mobileUsername"></span>
                        <button class="mobile-menu-item" id="mobileLogoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>登出</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="app-container">
        <!-- 聊天历史面板 -->
        <div class="history-panel" id="historyPanel">
            <div class="history-header">
                <h3><i class="fas fa-history"></i> 聊天历史</h3>
                <div class="history-controls">
                    <button class="btn-icon" id="newChatBtn" title="新建对话">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn-icon" id="exportHistoryBtn" title="导出历史">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" id="clearHistoryBtn" title="清空历史">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="history-search">
                <input type="text" id="historySearch" placeholder="搜索聊天记录..." />
                <i class="fas fa-search"></i>
            </div>
            <div class="session-list" id="sessionList">
                <!-- 会话列表将动态加载 -->
            </div>
        </div>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 欢迎界面 -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-header">
                        <h1 class="welcome-title">
                            <span class="gradient-text">智链</span>
                            <span class="subtitle">AI智能阅读助手</span>
                        </h1>
                        <p class="welcome-description">
                            上传链接、文档或图片，让AI助手为您提供智能分析和深度解读
                        </p>
                    </div>

                    <!-- 上传区域 -->
                    <div class="upload-section">
                        <div class="upload-tabs">
                            <button class="upload-tab active" data-type="text">
                                <i class="fas fa-keyboard"></i>
                                <span>文本输入</span>
                            </button>
                            <button class="upload-tab" data-type="url">
                                <i class="fas fa-link"></i>
                                <span>链接</span>
                            </button>
                            <button class="upload-tab" data-type="file">
                                <i class="fas fa-file-alt"></i>
                                <span>文档</span>
                            </button>
                            <button class="upload-tab" data-type="image">
                                <i class="fas fa-image"></i>
                                <span>图片</span>
                            </button>
                        </div>
                        
                        <div class="upload-content">
                            <!-- 文本输入面板 -->
                            <div class="upload-panel active" data-type="text">
                                <div class="input-wrapper">
                                    <textarea 
                                        id="textInput"
                                        placeholder="请输入要分析的文本内容..."
                                        rows="6"
                                    ></textarea>
                                </div>
                            </div>
                            
                            <!-- URL输入面板 -->
                            <div class="upload-panel" data-type="url">
                                <div class="input-wrapper">
                                    <textarea 
                                        id="urlInput"
                                        placeholder="请输入网页链接（支持多个，每行一个）"
                                        rows="4"
                                    ></textarea>
                                </div>
                            </div>
                            
                            <!-- 文件上传面板 -->
                            <div class="upload-panel" data-type="file">
                                <div class="file-upload-area" id="fileUploadArea">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <p class="upload-text">拖拽文件到此处或<span class="click-to-upload">点击选择</span></p>
                                    <p class="upload-hint">支持 PDF、DOCX、DOC、TXT、MD、CSV 格式，最大 10MB</p>
                                    <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,.md,.csv" multiple style="display: none;">
                                </div>
                                <div class="file-list" id="fileList"></div>
                            </div>
                            
                            <!-- 图片上传面板 -->
                            <div class="upload-panel" data-type="image">
                                <div class="image-upload-area" id="imageUploadArea">
                                    <div class="upload-icon">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <p class="upload-text">拖拽图片到此处或<span class="click-to-upload">点击选择</span></p>
                                    <p class="upload-hint">支持 JPG、PNG、GIF 格式，最大 10MB</p>
                                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                                </div>
                                <div class="image-preview" id="imagePreview"></div>
                            </div>
                        </div>
                        
                        <!-- 专家选择器 -->
                        <div class="expert-selector" id="expertSelector" style="display: none;">
                            <div class="selector-header">
                                <i class="fas fa-user-graduate"></i>
                                <span>选择分析专家</span>
                            </div>
                            <div class="expert-dropdown">
                                <select id="expertSelect" class="expert-select">
                                    <option value="">选择专家角色...</option>
                                    <!-- 专家选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- 主页模型选择器 -->
                        <div class="welcome-model-selector" id="welcomeModelSelector">
                            <button class="selector-button model-button" id="welcomeModelSelectorBtn">
                                <i class="fas fa-brain"></i>
                                <span id="welcomeModelButtonText">GLM-4-Flash</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="selector-dropdown" id="welcomeModelDropdown" style="display: none;">
                                <div class="dropdown-options" id="welcomeModelOptions">
                                    <div class="dropdown-option" data-value="GLM-4-Flash">
                                        <span class="option-name">GLM-4-Flash</span>
                                        <span class="option-desc">快速响应</span>
                                    </div>
                                    <div class="dropdown-option" data-value="GLM-Z1-Flash">
                                        <span class="option-name">GLM-Z1-Flash</span>
                                        <span class="option-desc">推理优化</span>
                                    </div>
                                    <div class="dropdown-option" data-value="DeepSeek-R1-Distill-Qwen-7B">
                                        <span class="option-name">DeepSeek-R1-Distill-Qwen-7B</span>
                                        <span class="option-desc">深度分析</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="upload-actions">
                            <button class="btn-primary" id="startAnalysisBtn">
                                <i class="fas fa-paper-plane"></i>
                                开始分析
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 聊天界面 -->
            <div class="chat-screen" id="chatScreen" style="display: none;">
                <div class="chat-container">
                    <!-- 聊天消息区域 -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- 消息将动态加载 -->
                    </div>

                    <!-- 进度指示器 -->
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-steps">
                            <div class="progress-step" data-step="1">
                                <div class="step-circle">1</div>
                                <span class="step-label">解析内容</span>
                            </div>
                            <div class="progress-step" data-step="2">
                                <div class="step-circle">2</div>
                                <span class="step-label">分析处理</span>
                            </div>
                            <div class="progress-step" data-step="3">
                                <div class="step-circle">3</div>
                                <span class="step-label">深度思考</span>
                            </div>
                            <div class="progress-step" data-step="4">
                                <div class="step-circle">4</div>
                                <span class="step-label">生成结果</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>

                    <!-- 输入区域 -->
                    <div class="chat-input-container">
                        <!-- 隐藏的选择器容器（用于数据存储） -->
                        <div class="hidden-selectors" style="display: none;">
                            <!-- 聊天模式专家选择器 -->
                            <div class="chat-expert-selector" id="chatExpertSelector">
                                <select id="chatExpertSelect" class="hidden-select">
                                    <option value="">选择专家角色...</option>
                                    <!-- 专家选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                            
                            <!-- 模型选择器 -->
                            <div class="chat-model-selector" id="chatModelSelector">
                                <select id="chatModelSelect" class="hidden-select">
                                    <option value="GLM-4-Flash">GLM-4-Flash（快速响应）</option>
                                    <option value="GLM-Z1-Flash">GLM-Z1-Flash（推理优化）</option>
                                    <option value="DeepSeek-R1-Distill-Qwen-7B">DeepSeek-R1-Distill-Qwen-7B（深度分析）</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 新的简化输入区域 -->
                        <div class="simplified-input-area">
                            <!-- 功能按钮（+号） -->
                            <div class="function-menu-container">
                                <button class="btn-function-menu" id="functionMenuBtn" title="更多功能">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <div class="function-menu-dropdown" id="functionMenuDropdown" style="display: none;">
                                    <div class="menu-section">
                                        <div class="menu-label">选择模型</div>
                                        <div class="menu-options" id="modelMenuOptions">
                                            <div class="menu-option" data-type="model" data-value="GLM-4-Flash">
                                                <span class="option-name">GLM-4-Flash</span>
                                                <span class="option-desc">快速响应</span>
                                                <i class="fas fa-check option-check" style="display: none;"></i>
                                            </div>
                                            <div class="menu-option" data-type="model" data-value="GLM-Z1-Flash">
                                                <span class="option-name">GLM-Z1-Flash</span>
                                                <span class="option-desc">推理优化</span>
                                                <i class="fas fa-check option-check" style="display: none;"></i>
                                            </div>
                                            <div class="menu-option" data-type="model" data-value="DeepSeek-R1-Distill-Qwen-7B">
                                                <span class="option-name">DeepSeek-R1-Distill-Qwen-7B</span>
                                                <span class="option-desc">深度分析</span>
                                                <i class="fas fa-check option-check" style="display: none;"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="menu-section" id="expertMenuSection" style="display: none;">
                                        <div class="menu-label">选择专家</div>
                                        <div class="menu-options" id="expertMenuOptions">
                                            <!-- 专家选项将通过JavaScript动态加载 -->
                                        </div>
                                    </div>
                                    
                                    <div class="menu-section">
                                        <div class="menu-label">切换模式</div>
                                        <div class="menu-options">
                                            <div class="menu-option" data-type="function" data-value="intelligent-reading">
                                                <i class="fas fa-book-reader"></i>
                                                <span class="option-name">智能伴读</span>
                                            </div>
                                            <div class="menu-option" data-type="function" data-value="comprehensive-analysis">
                                                <i class="fas fa-chart-line"></i>
                                                <span class="option-name">综合分析</span>
                                            </div>
                                            <div class="menu-option" data-type="function" data-value="expert-analysis">
                                                <i class="fas fa-user-graduate"></i>
                                                <span class="option-name">专家分析</span>
                                            </div>
                                            <div class="menu-option" data-type="function" data-value="fact-checking">
                                                <i class="fas fa-search"></i>
                                                <span class="option-name">事实核查</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="menu-section">
                                        <div class="menu-label">操作</div>
                                        <div class="menu-options">
                                            <div class="menu-option" data-type="action" data-value="clear">
                                                <i class="fas fa-broom"></i>
                                                <span class="option-name">清空对话</span>
                                            </div>
                                            <div class="menu-option" data-type="action" data-value="compact">
                                                <i class="fas fa-compress"></i>
                                                <span class="option-name">简洁模式</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 输入框 -->
                            <div class="input-wrapper">
                                <textarea 
                                    id="searchInput"
                                    placeholder="继续对话..."
                                    rows="1"
                                ></textarea>
                            </div>
                            
                            <!-- 发送按钮 -->
                            <button class="btn-send" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 进度分析界面 -->
            <div class="progress-screen" id="progressScreen" style="display: none;">
                <div class="progress-container rounded">
                    <div class="progress-header">
                        <h2 id="progressTitle">正在分析...</h2>
                        <button class="btn-icon" id="backToWelcomeBtn" title="返回主页">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>

                    <!-- Modified steps with rounded cards and Markdown support -->
                    <div class="progress-steps rounded-steps" id="progressSteps">
                        <!-- Steps will be dynamically generated with Markdown content -->
                    </div>
                    
                    <!-- 新的步骤界面设计 -->
                    <div class="analysis-results" id="analysisResults" style="display: none;">
                        <!-- 步骤卡片将动态生成 -->
                        <div class="markdown-content" id="markdownResults"></div>
                    </div>
                </div>
            </div>

            <!-- 步骤详情弹窗 -->
            <div class="step-detail-modal" id="stepDetailModal">
                <div class="step-detail-content">
                    <div class="step-detail-header">
                        <div class="step-detail-title-wrapper">
                            <div class="step-icon" id="stepDetailIcon">
                                <!-- 图标将由JS动态填充 -->
                            </div>
                            <div class="title-text-wrapper">
                                <h3 class="step-main-title" id="stepDetailMainTitle"></h3>
                                <small class="step-sub-title" id="stepDetailSubTitle"></small>
                            </div>
                        </div>
                        <button class="step-detail-close" aria-label="关闭">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="step-detail-body" id="stepDetailContent">
                        <!-- 详细内容将在这里显示 -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 模态框容器 -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <!-- 模态框内容将动态加载 -->
    </div>

    <!-- 认证模态框 -->
    <div class="modal-overlay" id="authModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="authTitle">登录</h3>
                <button class="close-btn" id="closeAuthModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="authForm">
                    <div class="form-group">
                        <label for="authUsername">用户名</label>
                        <input type="text" id="authUsername" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="authPassword">密码</label>
                        <input type="password" id="authPassword" name="password" required>
                    </div>
                    <div class="form-group" id="authEmailGroup" style="display: none;">
                        <label for="authEmail">邮箱</label>
                        <input type="email" id="authEmail" name="email">
                    </div>
                    <button type="submit" class="btn-primary" id="authSubmitBtn">登录</button>
                </form>
                <div class="auth-switch">
                    <span id="authSwitchText">还没有账号？</span>
                    <a href="#" id="authSwitchLink">立即注册</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div class="notification-container" id="notificationContainer">
        <!-- 通知将动态加载 -->
    </div>

    <!-- 加载指示器 -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="loadingText">正在处理...</p>
        </div>
    </div>

    <!-- JavaScript文件 -->
    <script src="js/utils.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/selector.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/chat-menu.js"></script>
    <script src="js/mobile-menu.js"></script>
    <script src="js/history.js"></script>
    <script src="js/app.js"></script>
    
    <!-- 调试脚本 -->
    <script>
        // 延迟执行调试
        setTimeout(() => {
            console.log('=== 调试信息 ===');
            console.log('authManager 存在:', !!window.authManager);
            console.log('DOM元素检查:');
            console.log('- authModal:', !!document.getElementById('authModal'));
            console.log('- authSwitchLink:', !!document.getElementById('authSwitchLink'));
            console.log('- loginBtn:', !!document.getElementById('loginBtn'));
            
            // 手动测试切换
            window.testSwitch = function() {
                console.log('手动测试切换...');
                if (window.authManager) {
                    window.authManager.showAuthModal('login');
                    setTimeout(() => {
                        const link = document.getElementById('authSwitchLink');
                        if (link) {
                            link.click();
                            console.log('已点击切换链接');
                        }
                    }, 500);
                }
            };
            
            console.log('可以在控制台运行 testSwitch() 来测试');
        }, 2000);
    </script>
</body>
</html>
